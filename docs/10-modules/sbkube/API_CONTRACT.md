# SBKube API Í≥ÑÏïΩ Î™ÖÏÑ∏

## Í∞úÏöî
Ïù¥ Î¨∏ÏÑúÎäî SBKube Î™®ÎìàÏùò ÎÇ¥Î∂Ä API Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ Í≥ÑÏïΩÏùÑ Ï†ïÏùòÌï©ÎãàÎã§. ÏÉàÎ°úÏö¥ Î™ÖÎ†πÏñ¥ÎÇò Ïï± ÌÉÄÏûÖÏùÑ Ï∂îÍ∞ÄÌï† Îïå Ïù¥ Í≥ÑÏïΩÏùÑ Ï§ÄÏàòÌï¥Ïïº Ìï©ÎãàÎã§.

## BaseCommand Ïù∏ÌÑ∞ÌéòÏù¥Ïä§

### ÌÅ¥ÎûòÏä§ ÏãúÍ∑∏ÎãàÏ≤ò
```python
class BaseCommand(ABC):
    """Î™®Îì† Î™ÖÎ†πÏñ¥Ïùò Í∏∞Î≥∏ ÌÅ¥ÎûòÏä§

    Ïù¥ ÌÅ¥ÎûòÏä§Î•º ÏÉÅÏÜçÌïòÏó¨ ÏÉà Î™ÖÎ†πÏñ¥Î•º Íµ¨ÌòÑÌï©ÎãàÎã§.
    """

    def __init__(
        self,
        base_dir: str | Path,
        app_config_dir: str | Path,
        target_app_name: Optional[str] = None,
        config_file_name: Optional[str] = None
    ):
        """
        Args:
            base_dir: ÏûëÏóÖ ÎîîÎ†âÌÜ†Î¶¨ (ÏùºÎ∞òÏ†ÅÏúºÎ°ú ÌîÑÎ°úÏ†ùÌä∏ Î£®Ìä∏)
            app_config_dir: ÏÑ§Ï†ï ÌååÏùº ÎîîÎ†âÌÜ†Î¶¨ (config/ Îì±)
            target_app_name: ÌäπÏ†ï Ïï±Îßå Ï≤òÎ¶¨ (--app ÏòµÏÖò)
            config_file_name: ÏÑ§Ï†ï ÌååÏùº Ïù¥Î¶Ñ (Í∏∞Î≥∏: config.yaml)
        """
```

### ÌïÑÏàò Íµ¨ÌòÑ Î©îÏÑúÎìú

#### execute()
```python
@abstractmethod
def execute(self) -> None:
    """Î™ÖÎ†πÏñ¥ Ïã§Ìñâ Î°úÏßÅ

    Ïù¥ Î©îÏÑúÎìúÎ•º Î∞òÎìúÏãú Íµ¨ÌòÑÌï¥Ïïº Ìï©ÎãàÎã§.

    Raises:
        SbkubeError: Î™ÖÎ†πÏñ¥ Ïã§Ìñâ Ï§ë Ïò§Î•ò Î∞úÏÉù Ïãú
    """
    pass
```

### Ï†úÍ≥µÎêòÎäî Ïú†Ìã∏Î¶¨Ìã∞ Î©îÏÑúÎìú

#### load_config()
```python
def load_config(self) -> SBKubeConfig:
    """config.yaml Î°úÎî© Î∞è Í≤ÄÏ¶ù

    Returns:
        SBKubeConfig: PydanticÏúºÎ°ú Í≤ÄÏ¶ùÎêú ÏÑ§Ï†ï Í∞ùÏ≤¥

    Raises:
        ConfigValidationError: ÏÑ§Ï†ï ÌååÏùº Í≤ÄÏ¶ù Ïã§Ìå® Ïãú
        FileNotFoundError: ÏÑ§Ï†ï ÌååÏùº ÏóÜÏùÑ Ïãú
    """
```

#### load_sources()
```python
def load_sources(self) -> SourcesConfig:
    """sources.yaml Î°úÎî© Î∞è Í≤ÄÏ¶ù

    Returns:
        SourcesConfig: Helm Ï†ÄÏû•ÏÜå Î∞è Git Î¶¨Ìè¨ÏßÄÌÜ†Î¶¨ ÏÑ§Ï†ï

    Raises:
        ConfigValidationError: Í≤ÄÏ¶ù Ïã§Ìå® Ïãú
    """
```

#### should_process_app()
```python
def should_process_app(self, app: AppInfoScheme) -> bool:
    """Ïï± Ï≤òÎ¶¨ Ïó¨Î∂Ä ÌåêÎã®

    Args:
        app: Ïï± Ï†ïÏùò Í∞ùÏ≤¥

    Returns:
        bool: TrueÎ©¥ Ï≤òÎ¶¨, FalseÎ©¥ Ïä§ÌÇµ

    Î°úÏßÅ:
        1. --app ÏòµÏÖò ÏßÄÏ†ï Ïãú Ìï¥Îãπ Ïï±Îßå Ï≤òÎ¶¨
        2. app.enabledÍ∞Ä FalseÎ©¥ Ïä§ÌÇµ
    """
```

### ÏÇ¨Ïö© ÏòàÏãú
```python
# commands/my_command.py
from sbkube.utils.base_command import BaseCommand

class MyCommand(BaseCommand):
    def execute(self):
        # 1. ÏÑ§Ï†ï Î°úÎî©
        config = self.load_config()

        # 2. Ïï±Î≥Ñ Ï≤òÎ¶¨
        for app in config.apps:
            if not self.should_process_app(app):
                continue

            # 3. ÌÉÄÏûÖÎ≥Ñ Î°úÏßÅ
            if app.type == 'helm':
                self.process_helm(app)
            elif app.type == 'yaml':
                self.process_yaml(app)

    def process_helm(self, app: AppInfoScheme):
        # Helm Ï≤òÎ¶¨ Î°úÏßÅ
        pass
```

## Pydantic Î™®Îç∏ Í≥ÑÏïΩ

### SBKubeConfig
```python
class SBKubeConfig(BaseModel):
    """config.yaml Î£®Ìä∏ Î™®Îç∏"""

    namespace: str  # Í∏∞Î≥∏ ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§
    deps: List[str] = Field(default_factory=list)  # Ï†ÑÏó≠ ÏùòÏ°¥ÏÑ± (Ìñ•ÌõÑ ÏÇ¨Ïö©)
    apps: List[AppInfoScheme]  # Ïï± Ï†ïÏùò Î™©Î°ù

    @field_validator('namespace')
    def validate_namespace(cls, v: str) -> str:
        """ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§ Ïú†Ìö®ÏÑ± Í≤ÄÏ¶ù"""
        if not v or not v.strip():
            raise ValueError('namespace must not be empty')
        return v
```

### AppInfoScheme
```python
class AppInfoScheme(BaseModel):
    """Í∞úÎ≥Ñ Ïï± Ï†ïÏùò Î™®Îç∏"""

    name: str  # Ïï± Ïù¥Î¶Ñ (Í≥†Ïú†Ìï¥Ïïº Ìï®)
    type: Literal[
        'exec', 'helm', 'install-action', 'yaml',
        'helm', 'helm-oci', 'pull-git', 'copy-app'
    ]  # Ïï± ÌÉÄÏûÖ
    path: Optional[str] = None  # Í≤ΩÎ°ú (ÌÉÄÏûÖÎ≥Ñ ÏùòÎØ∏ Îã§Î¶Ñ)
    enabled: bool = True  # ÌôúÏÑ±Ìôî Ïó¨Î∂Ä
    namespace: Optional[str] = None  # Ïï±Î≥Ñ ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§ (Ï†ÑÏó≠ Ïò§Î≤ÑÎùºÏù¥Îìú)
    release_name: Optional[str] = None  # Helm Î¶¥Î¶¨Ïä§ Ïù¥Î¶Ñ
    specs: Union[AppSpecBase, Dict[str, Any]] = Field(default_factory=dict)

    @field_validator('name')
    def validate_name(cls, v: str) -> str:
        """Ïï± Ïù¥Î¶Ñ Í≤ÄÏ¶ù (Í≥µÎ∞± Í∏àÏßÄ, ÌäπÏàòÎ¨∏Ïûê Ï†úÌïú)"""
        if not v or not v.strip():
            raise ValueError('app name must not be empty')
        return v
```

### AppSpecBase Î∞è ÏÑúÎ∏åÌÅ¥ÎûòÏä§
```python
class AppSpecBase(BaseModel):
    """Î™®Îì† SpecÏùò Í∏∞Î≥∏ ÌÅ¥ÎûòÏä§"""
    pass

class AppPullHelmSpec(AppSpecBase):
    """helm ÌÉÄÏûÖ Spec"""
    repo: str  # Helm Ï†ÄÏû•ÏÜå Ïù¥Î¶Ñ
    chart: str  # Ï∞®Ìä∏ Ïù¥Î¶Ñ
    version: str  # Ï∞®Ìä∏ Î≤ÑÏ†Ñ
    dest: str  # Ï†ÄÏû• Í≤ΩÎ°ú

class AppInstallHelmSpec(AppSpecBase):
    """helm ÌÉÄÏûÖ Spec"""
    path: str  # Ï∞®Ìä∏ Í≤ΩÎ°ú
    values: List[str] = Field(default_factory=list)  # values ÌååÏùº Î™©Î°ù

class AppInstallYamlSpec(AppSpecBase):
    """yaml ÌÉÄÏûÖ Spec"""
    actions: List[Dict[str, Any]]  # apply/delete Ïï°ÏÖò Î™©Î°ù

class AppCopyAppSpec(AppSpecBase):
    """copy-app ÌÉÄÏûÖ Spec"""
    paths: List[Dict[str, str]]  # src-dest Îß§Ìïë

class AppExecSpec(AppSpecBase):
    """exec ÌÉÄÏûÖ Spec"""
    commands: List[str]  # Ïã§ÌñâÌï† Î™ÖÎ†πÏñ¥ Î™©Î°ù
```

## ÏÉà Ïï± ÌÉÄÏûÖ Ï∂îÍ∞Ä Í≥ÑÏïΩ

### 1Îã®Í≥Ñ: Spec Î™®Îç∏ Ï†ïÏùò
```python
# sbkube/models/config_model.pyÏóê Ï∂îÍ∞Ä
class AppMyNewTypeSpec(AppSpecBase):
    """my-new-type Ïï± ÌÉÄÏûÖ Spec

    ÏÉà Ïï± ÌÉÄÏûÖÏùÑ Ï∂îÍ∞ÄÌï† Îïå AppSpecBaseÎ•º ÏÉÅÏÜçÌï©ÎãàÎã§.
    """
    # ÌïÑÏàò ÌïÑÎìú
    source_url: str = Field(..., description="ÏÜåÏä§ URL")

    # ÏÑ†ÌÉù ÌïÑÎìú
    target_path: Optional[str] = Field(None, description="Ï†ÄÏû• Í≤ΩÎ°ú")
    options: Dict[str, Any] = Field(default_factory=dict)

    @field_validator('source_url')
    def validate_url(cls, v: str) -> str:
        """URL Í≤ÄÏ¶ù Î°úÏßÅ"""
        if not v.startswith(('http://', 'https://')):
            raise ValueError('source_url must be HTTP(S) URL')
        return v
```

### 2Îã®Í≥Ñ: AppInfoScheme ÏóÖÎç∞Ïù¥Ìä∏
```python
class AppInfoScheme(BaseModel):
    type: Literal[
        'exec', 'helm', 'yaml',
        'helm', 'pull-git', 'copy-app',
        'my-new-type'  # Ï∂îÍ∞Ä
    ]
```

### 3Îã®Í≥Ñ: get_spec_model() Îß§Ìïë
```python
def get_spec_model(app_type: str):
    """Ïï± ÌÉÄÏûÖÎ≥Ñ Spec Î™®Îç∏ Î∞òÌôò"""
    spec_model_mapping = {
        'helm': AppPullHelmSpec,
        'helm': AppInstallHelmSpec,
        # ... Í∏∞Ï°¥ Îß§Ìïë
        'my-new-type': AppMyNewTypeSpec,  # Ï∂îÍ∞Ä
    }
    return spec_model_mapping.get(app_type, dict)
```

### 4Îã®Í≥Ñ: Î™ÖÎ†πÏñ¥Î≥Ñ Ï≤òÎ¶¨ Î°úÏßÅ Íµ¨ÌòÑ
Í∞Å Î™ÖÎ†πÏñ¥(prepare, build, template, deploy)ÏóêÏÑú ÏÉà ÌÉÄÏûÖ Ï≤òÎ¶¨:

```python
# commands/prepare.py
class PrepareCommand(BaseCommand):
    def execute(self):
        for app in config.apps:
            if app.type == 'my-new-type':
                self.prepare_my_new_type(app)

    def prepare_my_new_type(self, app: AppInfoScheme):
        spec = cast(AppMyNewTypeSpec, app.specs)
        # ÏÉà ÌÉÄÏûÖ Ï≤òÎ¶¨ Î°úÏßÅ
        download_from_url(spec.source_url, spec.target_path)
```

## Î°úÍπÖ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§

### logger Î™®Îìà ÏÇ¨Ïö©
```python
from sbkube.utils.logger import logger

# Î†àÎ≤®Î≥Ñ Î°úÍπÖ
logger.heading("üìã Build ÏãúÏûë")  # Ï†úÎ™© (ÌÅ∞ Î∞ïÏä§)
logger.info("‚úÖ Ïï± ÎπåÎìú ÏôÑÎ£å")   # ÏùºÎ∞ò Ï†ïÎ≥¥ (ÌååÎûÄÏÉâ)
logger.warning("‚ö†Ô∏è ÏÑ§Ï†ï ÎàÑÎùΩ")  # Í≤ΩÍ≥† (ÎÖ∏ÎûÄÏÉâ)
logger.error("‚ùå ÎπåÎìú Ïã§Ìå®")    # Ïò§Î•ò (Îπ®Í∞ÑÏÉâ)
logger.verbose("üîç ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥")  # ÎîîÎ≤ÑÍπÖ (--verbose ÏãúÎßå)
```

### Î°úÍπÖ Í∑úÏπô
1. **heading()**: Î™ÖÎ†πÏñ¥ ÏãúÏûë Ïãú Ìïú Î≤àÎßå
2. **info()**: Ï£ºÏöî ÏßÑÌñâ ÏÉÅÌô© ÌëúÏãú
3. **warning()**: Î¨∏Ï†úÎäî ÏïÑÎãàÏßÄÎßå Ï£ºÏùò ÌïÑÏöîÌïú Í≤ΩÏö∞
4. **error()**: Ïò§Î•ò Î∞úÏÉù Ïãú (Î∞∞Ìè¨Îäî Í≥ÑÏÜç)
5. **verbose()**: ÎîîÎ≤ÑÍπÖ Ï†ïÎ≥¥ (Í∏∞Î≥∏ÏùÄ Ïà®ÍπÄ)

## ÏóêÎü¨ Ï≤òÎ¶¨ Í≥ÑÏïΩ

### ÏòàÏô∏ ÌÅ¥ÎûòÏä§ Í≥ÑÏ∏µ
```python
class SbkubeError(Exception):
    """SBKube Í∏∞Î≥∏ ÏòàÏô∏

    Î™®Îì† SBKube ÏòàÏô∏Ïùò Î∂ÄÎ™® ÌÅ¥ÎûòÏä§
    """
    def __init__(self, message: str, exit_code: int = 1):
        self.message = message
        self.exit_code = exit_code

class CliToolNotFoundError(SbkubeError):
    """Ïô∏Î∂Ä CLI ÎèÑÍµ¨ ÎØ∏Î∞úÍ≤¨"""
    pass

class ConfigValidationError(SbkubeError):
    """ÏÑ§Ï†ï Í≤ÄÏ¶ù Ïò§Î•ò"""
    pass

class DeploymentError(SbkubeError):
    """Î∞∞Ìè¨ Ïã§Ìñâ Ïò§Î•ò"""
    pass
```

### ÏóêÎü¨ Ï≤òÎ¶¨ Í∞ÄÏù¥ÎìúÎùºÏù∏
```python
def execute(self):
    try:
        # Î™ÖÎ†πÏñ¥ Î°úÏßÅ
        self.process_apps()
    except CliToolNotFoundError as e:
        logger.error(f"Required tool not found: {e.message}")
        sys.exit(e.exit_code)
    except ConfigValidationError as e:
        logger.error(f"Configuration error: {e.message}")
        logger.info("Please check your config.yaml")
        sys.exit(e.exit_code)
    except Exception as e:
        logger.error(f"Unexpected error: {e}")
        sys.exit(1)
```

## ÏÉÅÌÉú Í¥ÄÎ¶¨ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§

### DeploymentState Î™®Îç∏
```python
class DeploymentState(Base):
    """Î∞∞Ìè¨ ÏÉÅÌÉú ORM Î™®Îç∏"""

    __tablename__ = 'deployment_states'

    id: str  # UUID
    app_name: str
    cluster_name: str
    namespace: str
    release_name: Optional[str]
    status: str  # 'success', 'failed', 'rollback'
    created_at: datetime
    metadata: dict  # JSON ÌïÑÎìú
```

### StateTracker Ïù∏ÌÑ∞ÌéòÏù¥Ïä§
```python
class StateTracker:
    """Î∞∞Ìè¨ ÏÉÅÌÉú Ï∂îÏ†Å ÌÅ¥ÎûòÏä§"""

    def begin_deployment(
        self,
        app_name: str,
        cluster: str,
        namespace: str
    ) -> str:
        """Î∞∞Ìè¨ ÏãúÏûë Í∏∞Î°ù

        Returns:
            str: deployment_id (UUID)
        """

    def mark_success(
        self,
        deployment_id: str,
        metadata: Optional[dict] = None
    ) -> None:
        """Î∞∞Ìè¨ ÏÑ±Í≥µ Í∏∞Î°ù"""

    def mark_failed(
        self,
        deployment_id: str,
        error: str
    ) -> None:
        """Î∞∞Ìè¨ Ïã§Ìå® Í∏∞Î°ù"""

    def get_history(
        self,
        cluster: Optional[str] = None,
        namespace: Optional[str] = None,
        app_name: Optional[str] = None,
        limit: int = 10
    ) -> List[DeploymentState]:
        """Î∞∞Ìè¨ ÌûàÏä§ÌÜ†Î¶¨ Ï°∞Ìöå"""
```

## Click Î™ÖÎ†πÏñ¥ Í≥ÑÏïΩ

### Î™ÖÎ†πÏñ¥ Îç∞ÏΩîÎ†àÏù¥ÌÑ∞ Ìå®ÌÑ¥
```python
@click.command(name="my-command")
@click.option('--base-dir', default='.', help='ÏûëÏóÖ ÎîîÎ†âÌÜ†Î¶¨')
@click.option('--app-dir', default='config', help='ÏÑ§Ï†ï ÎîîÎ†âÌÜ†Î¶¨')
@click.option('--app', help='ÌäπÏ†ï Ïï±Îßå Ï≤òÎ¶¨')
@click.option('--my-option', help='Ïª§Ïä§ÌÖÄ ÏòµÏÖò')
@click.pass_context
def cmd(ctx, base_dir, app_dir, app, my_option):
    """Î™ÖÎ†πÏñ¥ ÏÑ§Î™Ö

    ÏÉÅÏÑ∏ ÏÑ§Î™Ö...
    """
    command = MyCommand(base_dir, app_dir, app, my_option)
    command.execute()
```

### Ï†ÑÏó≠ Ïª®ÌÖçÏä§Ìä∏ Ï†ëÍ∑º
```python
@click.pass_context
def cmd(ctx, ...):
    # Ï†ÑÏó≠ ÏòµÏÖò Ï†ëÍ∑º
    kubeconfig = ctx.obj.get('kubeconfig')
    context = ctx.obj.get('context')
    namespace = ctx.obj.get('namespace')
    verbose = ctx.obj.get('verbose')
```

## Î≤ÑÏ†Ñ Ìò∏ÌôòÏÑ±

### API Î≥ÄÍ≤Ω Ï†ïÏ±Ö
- **Major Î≤ÑÏ†Ñ Î≥ÄÍ≤Ω**: Ìò∏Ìôò Î∂àÍ∞ÄÎä•Ìïú API Î≥ÄÍ≤Ω
- **Minor Î≤ÑÏ†Ñ Î≥ÄÍ≤Ω**: ÌïòÏúÑ Ìò∏Ìôò API Ï∂îÍ∞Ä
- **Patch Î≤ÑÏ†Ñ Î≥ÄÍ≤Ω**: Î≤ÑÍ∑∏ ÏàòÏ†ï (API Î≥ÄÍ≤Ω ÏóÜÏùå)

### ÌòÑÏû¨ Î≤ÑÏ†Ñ (v0.2.1)
- BaseCommand Ïù∏ÌÑ∞ÌéòÏù¥Ïä§: ÏïàÏ†ï
- Pydantic Î™®Îç∏: Ïã§ÌóòÏ†Å (v2 ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ï§ë)
- ÏÉÅÌÉú Í¥ÄÎ¶¨ API: Î≤†ÌÉÄ

---

**Î¨∏ÏÑú Î≤ÑÏ†Ñ**: 1.0
**ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏**: 2025-10-20
**Í¥ÄÎ†® Î¨∏ÏÑú**:
- [MODULE.md](MODULE.md) - Î™®Îìà Ï†ïÏùò
- [ARCHITECTURE.md](ARCHITECTURE.md) - ÏïÑÌÇ§ÌÖçÏ≤ò
- [DEPENDENCIES.md](DEPENDENCIES.md) - ÏùòÏ°¥ÏÑ± Î™ÖÏÑ∏
