apiVersion: sbkube/v1
metadata:
  name: hooks-pre-deploy-tasks
settings:
  namespace: pre-deploy-test
apps:
  postgres:
    type: helm
    enabled: true
    chart: grafana/postgresql
    version: 12.5.8
    values:
    - postgres-values.yaml
    hooks:
      pre_deploy_tasks:
      - type: command
        name: ensure-namespace
        command: |
          echo "Checking namespace: $SBKUBE_NAMESPACE"
          kubectl get namespace $SBKUBE_NAMESPACE || \
          kubectl create namespace $SBKUBE_NAMESPACE
          echo "Namespace ready"
      - type: manifests
        name: create-secret
        files:
        - manifests/secret.yaml
      - type: manifests
        name: create-config
        files:
        - manifests/app-config.yaml
      - type: command
        name: verify-environment
        command: bash scripts/verify-environment.sh
      post_deploy_tasks:
      - type: command
        name: verify-deployment
        command: |
          echo "Waiting for PostgreSQL..."
          kubectl wait --for=condition=ready pod \
            -l app.kubernetes.io/name=postgresql \
            -n $SBKUBE_NAMESPACE --timeout=300s
          echo "Deployment successful"
