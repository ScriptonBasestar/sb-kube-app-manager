# App Type: hook (HookApp)
#
# HookApp은 Phase 4에서 도입된 독립적인 app type입니다.
# prepare/build/template 단계를 건너뛰고 deploy 시에만 실행됩니다.
#
# 실행 방법:
#   sbkube apply --app-dir examples/app-types/09-hook
#
# HookApp 주요 특징:
# - 3가지 task type 지원: manifests, inline, command
# - depends_on으로 다른 앱과의 의존성 설정
# - task별 validation/rollback 지원
# - 앱 레벨 lifecycle 관리

namespace: default

apps:
  # HookApp 예제: 3가지 task type 시연
  setup-resources:
    type: hook  # HookApp type (v0.8.0+)

    # 메타데이터
    labels:
      app: hook-example
      component: setup
      managed-by: sbkube
    annotations:
      description: "Demonstrates all three HookApp task types"
      version: "1.0.0"

    # Tasks: 순차적으로 실행됨
    tasks:
      # Task 1: manifests type - 파일 기반 매니페스트 배포
      - type: manifests
        name: deploy-configmap
        files:
          - manifests/configmap.yaml
        validation:
          kind: ConfigMap
          name: app-config
          namespace: default
          wait_for_ready: true
          timeout: 60
        rollback:
          enabled: true
          on_failure: always
          commands:
            - kubectl delete configmap app-config -n default --ignore-not-found=true

      # Task 2: inline type - YAML을 config에 직접 포함
      - type: inline
        name: create-secret
        content:
          apiVersion: v1
          kind: Secret
          metadata:
            name: app-credentials
            namespace: default
            labels:
              app: hook-example
          type: Opaque
          stringData:
            username: "admin"
            password: "changeme"
            api-key: "demo-api-key-12345"
        validation:
          kind: Secret
          name: app-credentials
          namespace: default
          wait_for_ready: true
          timeout: 60
        rollback:
          enabled: true
          on_failure: always
          commands:
            - kubectl delete secret app-credentials -n default --ignore-not-found=true

      # Task 3: command type - 커스텀 명령어 실행
      - type: command
        name: verify-resources
        command: |
          echo "=== Verifying deployed resources ==="
          echo ""
          echo "ConfigMap:"
          kubectl get configmap app-config -n default -o yaml | grep -A 5 "data:"
          echo ""
          echo "Secret:"
          kubectl get secret app-credentials -n default -o jsonpath='{.metadata.name}' && echo " (exists)"
          echo ""
          echo "=== Verification complete ==="
        retry:
          max_attempts: 3
          delay: 5
        on_failure: warn  # 검증 실패 시 경고만 (배포는 계속)

    # 앱 레벨 rollback (모든 task 실패 시)
    rollback:
      enabled: true
      on_failure: always
      commands:
        - kubectl delete configmap app-config -n default --ignore-not-found=true
        - kubectl delete secret app-credentials -n default --ignore-not-found=true
