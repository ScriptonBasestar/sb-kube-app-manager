# 🧪 QA 시나리오: 스마트 재시작 및 진행률 시스템 테스트

## 📌 테스트 대상
- **작업 ID**: 008, 009, 010
- **기능**: 스마트 재시작, 실행 이력 관리, 실시간 진행률 표시
- **우선순위**: 🟡 High

## 🎯 테스트 목표
중단된 작업의 재시작, 실행 이력 추적, 실시간 진행률 표시가 올바르게 작동하는지 검증합니다.

---

## 📋 테스트 시나리오

### 1️⃣ 스마트 재시작 기본 기능 테스트

#### 1.1 정상 중단 후 재시작
```bash
# 1. build 단계에서 의도적 중단
sbkube run
# (build 단계 시작 후 Ctrl+C로 중단)

# 2. 상태 확인
ls -la .sbkube/execution_state.json
cat .sbkube/execution_state.json | jq .

# 3. 중단된 지점부터 재시작
sbkube run --resume
```

**예상 결과:**
- ✅ 실행 상태 파일 생성됨
- ✅ "이전 실행이 중단되었습니다. 재시작하시겠습니까?" 프롬프트
- ✅ build 단계부터 재개 (prepare 건너뜀)
- ✅ 완료 후 상태 파일 정리됨

#### 1.2 실패한 단계 재시도
```bash
# 1. 실패를 유발하는 설정 생성
cat > config/config.yaml << EOF
apps:
  - name: fail-app
    type: install-helm
    specs:
      chart: non-existent-chart
EOF

# 2. 실행 (deploy 단계에서 실패 예상)
sbkube run

# 3. 실패한 단계만 재시도
sbkube run --retry-failed
```

**예상 결과:**
- ❌ deploy 단계 실패
- ✅ 실행 상태에 실패 기록됨
- ✅ --retry-failed로 deploy만 재실행
- ✅ 성공한 단계는 건너뜀

---

### 2️⃣ 실행 이력 관리 테스트

#### 2.1 이력 자동 저장
```bash
# 여러 번 실행
sbkube run --only prepare
sbkube run --only build
sbkube run # 전체 실행

# 이력 확인
ls -la .sbkube/history/
find .sbkube/history -name "*.json" | head -5
```

**예상 결과:**
- ✅ 각 실행마다 타임스탬프된 파일 생성
- ✅ execution_YYYYMMDD_HHMMSS.json 형식
- ✅ 각 파일에 완전한 실행 정보 포함

#### 2.2 이력 기반 통계
```bash
# 10회 이상 실행 후
for i in {1..10}; do
  sbkube run --profile development
  sleep 2
done

# 실행 시간 분석 (가상의 명령어)
sbkube stats --step build
```

**예상 결과:**
- ✅ 단계별 평균 실행 시간
- ✅ 최근 10회 실행 통계
- ✅ 성공/실패 비율

#### 2.3 이력 정리
```bash
# 30일 이상 된 이력 자동 정리 확인
# (테스트를 위해 임의로 오래된 파일 생성)
touch -t 202401010000 .sbkube/history/old_execution.json

sbkube run

# 오래된 파일 삭제 확인
ls -la .sbkube/history/old_execution.json
```

**예상 결과:**
- ✅ 30일 이상 된 파일 자동 삭제
- ✅ 최근 이력은 유지
- ✅ 정리 로그 메시지

---

### 3️⃣ 실시간 진행률 표시 테스트

#### 3.1 기본 진행률 표시
```bash
# 진행률 표시와 함께 실행
sbkube run
```

**예상 화면:**
```
🚀 SBKube 실행 중...
프로파일: default | 네임스페이스: my-app

전체 진행률: [████████░░░░░░░░░░░░] 40% (2/4 단계)
✅ prepare (30s)
✅ build (2m 15s)
⏳ template

현재 단계: template
[████████████░░░░░░░] 60% - 템플릿 렌더링 중...
경과: 00:02:45 | 예상 완료: 00:01:50
```

#### 3.2 진행률 없는 실행
```bash
# 진행률 표시 비활성화
sbkube run --no-progress
```

**예상 결과:**
- ✅ 기존 방식의 로그 출력
- ✅ 진행률 바 없음
- ✅ 단계별 시작/완료 메시지만 표시

#### 3.3 단계별 세부 진행률
```bash
# build 단계만 실행하여 세부 진행률 확인
sbkube run --only build
```

**예상 세부 진행률:**
```
현재 단계: build
[████░░░░░░░░░░░░░░░░] 20% - Helm 차트 다운로드 중...
[████████░░░░░░░░░░░░] 40% - 의존성 빌드 중...
[████████████░░░░░░░░] 60% - 이미지 준비 중...
[████████████████░░░░] 80% - 패키징 중...
[████████████████████] 100% - 완료!
```

---

### 4️⃣ 통합 시나리오 테스트

#### 4.1 재시작 + 진행률
```bash
# 1. 진행률 표시 중 중단
sbkube run
# (template 단계 50%에서 Ctrl+C)

# 2. 재시작 시 진행률 복원
sbkube run --resume
```

**예상 결과:**
- ✅ 중단 시점의 단계 정보 저장
- ✅ 재시작 시 이전 단계 완료 표시
- ✅ 중단된 단계부터 진행률 0%로 시작

#### 4.2 프로파일별 시간 추정
```bash
# 다른 프로파일로 여러 번 실행
sbkube run --profile development  # 빠른 실행
sbkube run --profile production   # 느린 실행 (더 많은 검증)

# 시간 추정 확인
sbkube run --profile production
```

**예상 결과:**
- ✅ 프로파일별 독립적 시간 통계
- ✅ production이 더 긴 예상 시간 표시
- ✅ 실행할수록 정확도 향상

---

### 5️⃣ 오류 상황 테스트

#### 5.1 상태 파일 손상
```bash
# 상태 파일 의도적 손상
echo "invalid json" > .sbkube/execution_state.json

sbkube run --resume
```

**예상 결과:**
- ⚠️ 경고: "실행 상태 파일이 손상되었습니다"
- ❓ "처음부터 다시 시작하시겠습니까?"
- ✅ 손상된 파일 백업 후 정리

#### 5.2 동시 실행 방지
```bash
# 터미널 1
sbkube run

# 터미널 2 (거의 동시에)
sbkube run
```

**예상 결과:**
- ❌ 오류: "다른 sbkube 프로세스가 실행 중입니다"
- ✅ 실행 중인 프로세스 PID 표시
- ✅ 잠금 파일 메커니즘 작동

#### 5.3 진행률 표시 중 터미널 크기 변경
```bash
# 실행 중 터미널 크기 조정
sbkube run
# (실행 중 터미널 창 크기 변경)
```

**예상 결과:**
- ✅ 레이아웃 자동 조정
- ✅ 진행률 바 크기 적응
- ✅ 표시 깨짐 없음

---

### 6️⃣ 성능 테스트

#### 6.1 대량 이력 파일 처리
```bash
# 1000개의 이력 파일 생성 (테스트용)
for i in {1..1000}; do
  cp .sbkube/history/sample.json .sbkube/history/test_$i.json
done

# 성능 측정
time sbkube run --only prepare
```

**예상 결과:**
- ✅ 이력 로딩 시간 < 1초
- ✅ 메모리 사용량 정상
- ✅ 최근 100개만 통계에 사용

#### 6.2 진행률 업데이트 빈도
```bash
# CPU 사용률 모니터링하며 실행
top -p $(pgrep -f sbkube)
sbkube run
```

**예상 결과:**
- ✅ CPU 사용률 < 5% (진행률 표시)
- ✅ 250ms 간격 업데이트
- ✅ 부드러운 애니메이션

---

## 🔍 검증 체크리스트

### 재시작 기능
- [ ] 중단 지점 정확히 기억
- [ ] 상태 파일 관리
- [ ] 실패 단계 재시도
- [ ] 잠금 메커니즘

### 이력 관리
- [ ] 자동 저장/로드
- [ ] 통계 정확성
- [ ] 자동 정리
- [ ] 프로파일별 분리

### 진행률 표시
- [ ] 실시간 업데이트
- [ ] 시간 추정 정확도
- [ ] UI 반응성
- [ ] 터미널 호환성

---

## 📊 테스트 결과 기록

| 테스트 항목 | 상태 | 실행일 | 담당자 | 비고 |
|-----------|------|--------|---------|------|
| 스마트 재시작 | - | - | - | - |
| 이력 관리 | - | - | - | - |
| 진행률 표시 | - | - | - | - |
| 통합 시나리오 | - | - | - | - |
| 성능 테스트 | - | - | - | - |

---

## 🐛 발견된 이슈

### 이슈 템플릿
```markdown
**이슈 ID**: RESTART-001
**심각도**: High/Medium/Low
**기능**: 재시작/이력/진행률
**재현 단계**:
1. 
2. 

**예상 동작**:

**실제 동작**:

**로그/스크린샷**:
```

---

## 📝 개선 제안

1. **재시작 개선**
   - 체크포인트 세분화
   - 부분 단계 재시작
   - 병렬 작업 상태 저장

2. **이력 활용**
   - 실행 패턴 분석
   - 최적화 제안
   - 이상 탐지

3. **진행률 향상**
   - 더 정확한 시간 예측
   - 단계별 상세 정보
   - 진행률 내보내기 (CI/CD용)