# SBKube Hooks 예제
#
# hooks 기능을 사용하여 배포 전후에 커스텀 스크립트를 실행할 수 있습니다.

namespace: hooks-demo

# 전역 훅 (모든 앱 배포에 적용)
hooks:
  deploy:
    pre:
      - echo "=== Deployment started at $(date) ==="
      - echo "Checking cluster connectivity..."
      - kubectl cluster-info
    post:
      - echo "=== Deployment completed at $(date) ==="
      - echo "Listing all pods in namespace..."
      - kubectl get pods -n hooks-demo
    on_failure:
      - echo "=== Deployment failed at $(date) ==="
      - echo "Check the error messages above"

apps:
  # 예제 1: Redis - 앱별 훅 사용
  redis:
    type: helm
    chart: bitnami/redis
    version: 18.0.0
    namespace: hooks-demo
    hooks:
      pre_deploy:
        - echo "🚀 Preparing to deploy Redis..."
        - echo "Checking if Redis is already running..."
        - kubectl get pods -l app.kubernetes.io/name=redis -n hooks-demo || echo "Redis not found, proceeding with deployment"
      post_deploy:
        - echo "✅ Redis deployed successfully!"
        - echo "Waiting for Redis to be ready..."
        - kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=redis -n hooks-demo --timeout=300s
        - echo "Redis is ready!"
      on_deploy_failure:
        - echo "❌ Redis deployment failed!"
        - echo "Checking pod status..."
        - kubectl get pods -l app.kubernetes.io/name=redis -n hooks-demo
        - kubectl describe pods -l app.kubernetes.io/name=redis -n hooks-demo

  # 예제 2: Nginx - 간단한 post-deploy 헬스체크
  nginx:
    type: yaml
    files:
      - manifests/nginx-deployment.yaml
      - manifests/nginx-service.yaml
    namespace: hooks-demo
    hooks:
      post_deploy:
        - echo "Running health check for Nginx..."
        - sleep 5
        - kubectl get svc nginx -n hooks-demo
        - echo "Nginx service is up!"
